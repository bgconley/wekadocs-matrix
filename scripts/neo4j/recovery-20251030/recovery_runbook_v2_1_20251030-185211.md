# Recovery runbook â€” Phase 7E-4 / GraphRAG v2.1

## Preconditions
- Ensure you have shell access to the Compose project.
- Confirm services listed: `mcp-server`, `ingestion-service`, `ingestion-worker`, `neo4j`, `qdrant`, `redis`.

## 1) Quiesce traffic
```bash
docker-compose stop ingestion-worker ingestion-service || true
```

## 2) Snapshot current state (forensics)
```bash
# Neo4j (dump db if available, otherwise export schema)
docker exec weka-neo4j cypher-shell -u $NEO4J_USER -p $NEO4J_PASS "SHOW CONSTRAINTS; SHOW INDEXES;" > /backups/neo4j_schema_before.txt
```

## 3) Apply canonical Neo4j DDL (idempotent)
Apply the generated file: `/mnt/data/neo4j_ddl_v2_1_idempotent_20251030-185211.cypher`
```bash
docker cp /mnt/data/neo4j_ddl_v2_1_idempotent_20251030-185211.cypher weka-neo4j:/tmp/ddl.cypher
docker exec weka-neo4j cypher-shell -u $NEO4J_USER -p $NEO4J_PASS -f /tmp/ddl.cypher
```

## 4) Ensure Qdrant collections exist and match canonical settings
Run: `qdrant_setup_v2_1_20251030-185211.sh` (idempotent)
```bash
bash /mnt/data/qdrant_setup_v2_1_20251030-185211.sh
```

## 5) Redis hygiene (test DB only)
If your test Redis DB was used, flush **only** the test DB.
```bash
redis-cli -h 127.0.0.1 -p 6379 -n "${REDIS_DB_TEST:-1}" FLUSHDB ASYNC
```

## 6) Restart MCP and verify health
```bash
docker-compose restart mcp-server
sleep 10 && docker logs weka-mcp-server --tail 200 | sed -n '/Running startup health checks/,$p'
```
You should see all checks pass, including `schema_version` and `neo4j_indexes`.

## 7) Bring ingestion back online
```bash
docker-compose up -d ingestion-service ingestion-worker
```

## Notes
- This process **does not** drop or recreate the Neo4j database; it only ensures constraints/indexes and the singleton metadata node.
- The Qdrant script uses `PUT /collections/{name}` which is idempotent; it creates if missing and updates where supported.
- The SchemaVersion node is enforced via a uniqueness constraint on `sv.id` and maintained via `MERGE`.
