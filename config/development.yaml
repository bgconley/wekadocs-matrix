# WekaDocs Matrix Configuration - Development Environment
# This is the single source of truth for all configuration values
# Eliminates phantom defaults and hardcoded values throughout the codebase

# Application metadata
app:
  name: wekadocs-matrix
  environment: development
  log_level: INFO
  version: "2.0.0"

# Embedding configuration - critical for vector operations
# Default to BGE-M3 (dense + sparse + ColBERT)
embedding:
  profile: "bge_m3"
  # Model configuration (ENV overrideable via EMBEDDINGS_MODEL)
  model_name: "BAAI/bge-m3"
  dims: 1024
  similarity: "cosine"  # Options: cosine, dot, euclidean

  # Version tracking for provenance
  version: "BAAI/bge-m3"

  # Provider configuration (ENV overrideable via EMBEDDINGS_PROVIDER)
  provider: "bge-m3-service"

  # Task configuration
  task: "symmetric"  # Options: symmetric (BGE-M3), retrieval.passage, retrieval.query

  # Performance settings
  batch_size: 32
  max_sequence_length: 4096  # BGE-M3 service default

# Tokenizer configuration
tokenizer:
  backend: "hf"  # Options: hf, segmenter (overridden by TOKENIZER_BACKEND env)

# Search configuration
search:
  # Vector search settings
  vector:
    primary: "qdrant"
    dual_write: false  # Phase 7C: Set to true during migration
    qdrant:
      collection_name: "chunks_multi_bge_m3"  # Phase 7E+: Multi-vector collection (BGE-M3)
      use_grpc: false
      timeout: 30
      allow_recreate: false  # Set true to auto-rebuild collections during schema upgrades
      enable_sparse: true
      enable_colbert: true
      # Graph Channel Rehabilitation: Sparse embedding error handling mode
      # false = graceful degradation (default) - insert None placeholder on failure
      # true = strict mode - fail ingestion if sparse embedding fails
      sparse_strict_mode: false
      use_query_api: true
      query_api_dense_limit: 200
      query_api_sparse_limit: 200
      query_api_candidate_limit: 200
      query_vector_name: "content"
      query_strategy: "weighted"  # Options: content_only, weighted, max_field
    neo4j:
      index_name: "section_embeddings_v2"  # Phase 7C: New 1024-D index

  # Hybrid search settings (Phase 7E: RRF + BM25)
  hybrid:
    # Architecture mode: legacy (BM25+RRF) or bge_reranker (vector-only + cross-encoder)
    mode: "bge_reranker"
    enabled: true  # Phase 7E: Enable hybrid retrieval
    graph_channel_enabled: true  # Enable graph as independent scoring channel in fusion
    method: "weighted"  # Architecture 2: magnitude-preserving fusion

    # RRF (Reciprocal Rank Fusion) settings
    rrf_k: 60  # Phase 7E: RRF constant (default: 60)

    # Weighted fusion settings (alternative to RRF)
    fusion_alpha: 0.6  # Phase 7E: Vector weight (0.0-1.0), BM25 weight = 1-alpha

    # Legacy weights (for backward compatibility)
    vector_weight: 0.7  # Weight for vector similarity (0.0-1.0)
    graph_weight: 0.3   # Weight for graph/text match
    semantic_recall_weight: 0.4
    semantic_rerank_weight: 0.4
    semantic_graph_weight: 0.2
    reranker_veto_threshold: 0.2
    graph_propagation_decay: 0.85

    # Vector field weights (dense + sparse) for Qdrant multi-vector fusion
    vector_fields:
      content: 0.5
      title: 0.1
      entity: 0.1
      text-sparse: 0.3
    query_type_weights:
      conceptual: { vector: 0.7, graph: 0.3 }
      cli: { vector: 0.5, graph: 0.5 }
      config: { vector: 0.5, graph: 0.5 }
      procedural: { vector: 0.6, graph: 0.4 }
      troubleshooting: { vector: 0.7, graph: 0.3 }
      reference: { vector: 0.7, graph: 0.3 }
    # Optional: query-type relationship sets (used if graph_adaptive_enabled)
    query_type_relationships:
      conceptual: ["MENTIONED_IN", "DEFINES", "IN_SECTION"]
      cli: ["MENTIONED_IN", "CONTAINS_STEP", "HAS_PARAMETER"]
      config: ["MENTIONED_IN", "HAS_PARAMETER", "DEFINES"]
      procedural: ["MENTIONED_IN", "CONTAINS_STEP", "NEXT_CHUNK", "IN_SECTION"]
      troubleshooting: ["MENTIONED_IN", "AFFECTS", "CAUSED_BY", "RESOLVES", "NEXT_CHUNK"]
      reference: ["MENTIONED_IN", "NEXT_CHUNK"]

    reranker:
      enabled: true
      provider: "bge-reranker-service"  # options: bge-reranker-service, jina-ai, noop
      model: "BAAI/bge-reranker-v2-m3"
      top_n: 20            # how many candidates to send to the reranker
      max_pairs: 50        # hard cap to protect latency
      max_tokens_per_pair: 1024  # truncate long docs before rerank

    top_k: 20  # Number of candidates to retrieve

    # BM25/keyword retrieval settings
    bm25:
      enabled: true  # re-enable lexical recall
      top_k: 50  # Retrieve more candidates for fusion
      weight: 0.15  # Lower weight while sparse is primary lexical channel

    # Bounded adjacency expansion (Phase 7E)
    expansion:
      enabled: true  # Enable bounded neighbor expansion
      max_neighbors: 1
      query_min_tokens: 8
      score_delta_max: 0.05
      sparse_score_threshold: 0.15  # Gating threshold for sparse lexical scores on expanded neighbors
      rescoring:
        enabled: true
        mode: "weighted"
        normalize_method: "min_max"  # min_max | sigmoid
        weights:
          lexical: 0.4
          structural: 0.5
          proximity: 0.1
      # Structure-aware expansion (Phase C.4)
      structure:
        sibling_limit: 3           # Max sibling chunks from same parent_section
        parent_section_limit: 2    # Max chunks from parent section
        shared_entity_limit: 3     # Max chunks sharing entities with top results
        timeout_ms: 100            # Max latency budget for structure expansion

# Graph search settings
  graph:
    max_depth: 3
    max_related_per_seed: 20

  # Response building (Phase 7E: Context budget enforcement)
  response:
    max_bytes_full: 32768  # 32KB limit for FULL mode
    max_sections: 10
    include_citations: true

    # Phase 7E: Answer context budget (tokens)
    answer_context_max_tokens: 4500  # Max tokens for LLM context window

# Database connections
databases:
  neo4j:
    # Connection details from environment variables
    uri_env: "NEO4J_URI"
    username_env: "NEO4J_USERNAME"
    password_env: "NEO4J_PASSWORD"  # pragma: allowlist secret
    database: "neo4j"

  qdrant:
    # Connection details
    host_env: "QDRANT_HOST"
    port_env: "QDRANT_PORT"
    api_key_env: "QDRANT_API_KEY"  # pragma: allowlist secret
    timeout: 30

  redis:
    # Connection details
    host_env: "REDIS_HOST"
    port_env: "REDIS_PORT"
    password_env: "REDIS_PASSWORD"  # pragma: allowlist secret
    db: 0

# Ingestion settings
ingestion:
  # Batch processing
  batch_size: 500
  max_section_tokens: 1000
  timeout_seconds: 300
  workers: 2

  # Phase 7E-2: Chunk assembly configuration
  # Controls intelligent combining and splitting for optimal retrieval quality
  chunk_assembly:
    assembler: "structured"
    structure:
      min_tokens: 350
      target_tokens: 500
      hard_tokens: 750
      max_sections: 4
      respect_major_levels: true
      stop_at_level: 2
      break_keywords: "faq|faqs|glossary|reference|api reference|cli reference|changelog|release notes|troubleshooting"
    split:
      enabled: true
      max_tokens: 750
      overlap_tokens: 100
    microdoc:
      enabled: true
      doc_token_threshold: 2000
      min_split_tokens: 400
    semantic:
      enabled: false
      provider: "stub"
      model_name: null
      timeout_seconds: 5

  # Queue recovery (Phase 6: job reaper)
  queue_recovery:
    enabled: true
    job_timeout_seconds: 600
    reaper_interval_seconds: 30
    max_retries: 3
    stale_job_action: requeue

  # Reconciliation (for drift detection)
  reconciliation:
    enabled: true
    schedule: "0 2 * * *"  # 2 AM daily
    drift_threshold: 0.01

# Ranking configuration
ranking:
  # Score normalization
  normalize_scores: true
  score_range: [0.0, 1.0]

  # Recency weighting
  recency:
    enabled: true
    decay_factor: 365  # Days for exponential decay

  # Entity focus (Phase 7 will activate)
  entity_focus:
    enabled: false  # Will be true in Phase 7
    boost_weight: 0.2

  # Coverage signals
  coverage:
    enabled: true
    connection_weight: 0.1
    mention_weight: 0.15

# Schema configuration
schema:
  version: "v2.2"  # Phase 7E+: Hybrid retrieval enablement with multi-vector support
  auto_migrate: false

# Rate limiting configuration
rate_limit:
  enabled: true
  requests_per_minute: 60
  burst_size: 10
  window_seconds: 60

# Authentication configuration
auth:
  enabled: true
  algorithm: "HS256"
  expiry_minutes: 60

# Audit logging configuration
audit:
  enabled: true
  log_params: true
  log_results: false
  retention_days: 90

# Query validator configuration
validator:
  max_depth: 3
  max_label_scans: 2
  max_expand_ops: 5
  max_estimated_rows: 10000
  timeout_seconds: 30
  enforce_parameters: true
  enforce_limits: true

# Telemetry configuration
telemetry:
  enabled: true

# Cache configuration (Phase 7E-3: Epoch-based invalidation)
cache:
  l1:
    enabled: true
    ttl_seconds: 300
    max_size: 1000
  l2:
    enabled: true
    ttl_seconds: 3600
    key_prefix: "weka:cache:v1"

  # Phase 7E-3: Cache invalidation configuration
  # Reference: Canonical Spec L3184-3281 (epoch), L3116-3183 (scan)
  invalidation:
    mode: "epoch"  # Options: epoch (O(1) preferred), scan (fallback)
    namespace: "rag:v1"  # Cache namespace for epoch/pattern keys
    redis_uri: null  # Falls back to CACHE_REDIS_URI or REDIS_URL env vars

  # Note: Epoch counters are stored in Redis:
  #   - {namespace}:doc_epoch -> HSET {document_id} -> epoch_int
  #   - {namespace}:chunk_epoch -> HSET {chunk_id} -> epoch_int

# Feature flags for gradual rollout
feature_flags:
  use_embedding_provider: true  # New in pre-phase7
  validate_dimensions: true     # New in pre-phase7
  coverage_enrichment: true      # New in pre-phase7
  byte_cap_responses: true       # New in pre-phase7
  schema_v2_1_dev: true         # Dev only for pre-phase7
  dual_write_1024d: false       # Phase 7C.4: Enable dual-write to both 384-D and 1024-D indices
  # New rollout flags for retrieval rehab
  query_api_weighted_fusion: false
  graph_garbage_filter: true       # C.0.1: Filter short/stopword entities
  graph_rel_types_wired: true      # C.0.2: Use query-adaptive relationship types
  dedup_best_score: true           # C.0.3: Keep highest score in dedup (enabled 2025-11-26)
  graph_score_normalized: true     # C.0.4: Saturating exponential normalization
  graph_as_reranker: false
  entity_embedding_fallback: false
  structure_aware_expansion: true  # C.4: Sibling/parent/entity context expansion (enabled 2025-11-26)

# Phase 7E-4: Monitoring and observability configuration
# Reference: Canonical Spec L4916-4976, L3513-3528
monitoring:
  # Health checks
  health_checks_enabled: true  # Run health checks at startup
  health_check_fail_fast: true  # Fail startup if critical checks fail

  # SLO monitoring
  slo_monitoring_enabled: true  # Enable SLO tracking and alerting

  # SLO thresholds (from canonical spec)
  retrieval_p95_target_ms: 500  # Retrieval p95 latency target (ms)
  ingestion_target_seconds: 10  # Ingestion duration target (seconds)
  expansion_rate_min: 0.10  # Minimum expansion rate (10%)
  expansion_rate_max: 0.40  # Maximum expansion rate (40%)

  # Metrics collection
  metrics_enabled: true  # Enable Prometheus metrics collection
  metrics_aggregation_enabled: true  # Enable metrics aggregation for dashboards

# Performance tuning
performance:
  # Connection pools
  neo4j_max_connections: 50
  qdrant_max_connections: 20

  # Timeouts (seconds)
  default_timeout: 30
  embedding_timeout: 10
  search_timeout: 5

  # Caching
  cache_ttl_seconds: 3600
  cache_max_size: 1000

# Development settings
development:
  # Debug options
  debug: false
  verbose_logging: false

# Connectors configuration
connectors:
  queue_max_size: 10000
  github:
    enabled: false
    poll_interval_seconds: 300
    batch_size: 50
    max_retries: 3
    backoff_base_seconds: 2.0
    circuit_breaker_enabled: true
    circuit_breaker_failure_threshold: 5
    circuit_breaker_timeout_seconds: 60
    docs_path: "docs"
    owner: null
    repo: null
    webhook_secret: null

# Testing helpers
use_mock_embeddings: false
deterministic_ids: true

# Hot reload
watch_config: true
reload_on_change: false

  # Testing helpers
  # (moved to root; kept comment as reminder)
